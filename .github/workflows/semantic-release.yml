name: Semantic Version Release

on:
    workflow_dispatch:
        inputs:
            version_type:
                description: "Version bump type"
                required: true
                default: "patch"
                type: choice
                options:
                    - major
                    - minor
                    - patch
            description:
                description: "Release description/changelog entry"
                required: true
                type: string

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm ci

            - name: Compile and verify
              run: npm run compile

            - name: Run linting
              run: npm run lint

            - name: Run tests
              run: npm test

            - name: Get current version
              id: current_version
              run: |
                  VERSION=$(node -p "require('./package.json').version")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Calculate new version
              id: new_version
              run: |
                  CURRENT="${{ steps.current_version.outputs.version }}"
                  TYPE="${{ github.event.inputs.version_type }}"

                  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

                  if [ "$TYPE" = "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                  elif [ "$TYPE" = "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                  else
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="$MAJOR.$MINOR.$PATCH"
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

            - name: Update package.json version
              run: |
                  npm version ${{ steps.new_version.outputs.version }} --no-git-tag-version

            - name: Update CHANGELOG.md
              run: |
                  DATE=$(date +"%Y-%m-%d")
                  CHANGELOG_ENTRY="## Version ${{ steps.new_version.outputs.version }} - $DATE

                  ${{ github.event.inputs.description }}

                  "

                  # Insert after the first ## heading or at the top
                  {
                    echo "$CHANGELOG_ENTRY"
                    cat CHANGELOG.md
                  } > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md

            - name: Configure Git
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"

            - name: Commit changes
              run: |
                  git add package.json CHANGELOG.md
                  git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"

            - name: Create and push tag
              run: |
                  git tag -a v${{ steps.new_version.outputs.version }} -m "Release v${{ steps.new_version.outputs.version }}"
                  git push origin main --follow-tags

            - name: Build extension
              run: npm run package

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ steps.new_version.outputs.version }}
                  name: Release v${{ steps.new_version.outputs.version }}
                  body: ${{ github.event.inputs.description }}
                  files: annotative-*.vsix
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
